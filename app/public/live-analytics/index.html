<!DOCTYPE html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <title>Shortly</title>

    <!-- Bootstrap core CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }
      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    <!-- Custom styles for this template -->
    <link href="../cover.css" rel="stylesheet" />
    <script>
      let analytics_service;
      createRow = function (data) {
        const template = document.querySelector("#linkRow");
        const clone = template.content.cloneNode(true);
        clone.querySelector("tr").id = `id-${data.id}`;
        clone.querySelector("th").textContent = data.id;
        let td = clone.querySelectorAll("td");
        td[0].textContent = data.short;
        td[1].textContent = data.long;
        td[2].textContent = data.count;
        return clone;
      };
      append = function (link) {
        if (link.id) {
          const table = document.getElementById("links_table");
          const row = table.querySelector(`#id-${link.id}`);
          console.log(row);
          if (row) {
            row.replaceWith(createRow(link));
          } else {
            table.appendChild(createRow(link));
          }
        }
      };
      setInfo = function (text) {
        document.getElementById("websocket_events").innerHTML =
          "<span>" + text + "</span>";
      };
      window.onload = function () {
        const url = new URL(window.location.href);
        const token = url.searchParams.get("token");
        if (!token) {
          const err = "Error: Specify a 'token' as a query parameter. e.g. token=<YOUR_TOKEN>"
          setInfo(err);
          window.alert(err);
        }

        analytics_service = new WebSocket(
          `ws://live.shortly.txttw.online/websocket?token=${token}`
          //`ws://127.0.0.1:8787/websocket?token=${token}`

        );
        analytics_service.onmessage = function (event) {
          const data = JSON.parse(event.data);
          if (data.message) {
            setInfo(data.message);
          } else {
            append(data);
          }
        };
        analytics_service.onopen = function () {
          setInfo("ðŸš€ Connected to WebSocket!");
        };
        analytics_service.onclose = function () {
          setInfo("Connection closed");
        };
        analytics_service.onerror = function () {
          setInfo("Error happens");
        };
      };

      function sendMessage(event) {
        let message = document.getElementById("message").value;
        if (analytics_service) {
          analytics_service.send(message);
        }
      }
    </script>
  </head>
  <body class="d-flex h-100 text-white bg-dark">
    <div class="cover-container h-100 d-flex w-100 p-3 mx-auto flex-column">
      <header class="mb-5">
        <div>
          <h3 class="float-md-start mb-0 fw-bold">Shortly</h3>
          <nav class="nav nav-masthead justify-content-center float-md-end">
            <a class="nav-link" aria-current="page" href="/">Home</a>
            <a class="nav-link active" href="/live-analytics">Live Analytics</a>
          </nav>
        </div>
      </header>
      <main class="container">
        <div class="mb-4">
          <h5>Test the connection by sending a message</h5>
          <div class="input-group input-group-sm mb-3">
            <input
              id="message"
              type="text"
              class="form-control"
              placeholder="Message"
            />
            <div class="input-group-append">
              <button
                class="btn btn-primary"
                type="button"
                onclick="sendMessage(event)"
              >
                Send
              </button>
            </div>
          </div>
          <h5>Recieved</h5>
          <div id="websocket_events"></div>
        </div>

        <h3 class="text-center mb-3">Analytics</h3>
        <table id="links_table" class="table table-dark">
          <thead>
            <tr>
              <th scope="col">Id</th>
              <th scope="col">Short</th>
              <th scope="col">Long</th>
              <th scope="col">Count</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </main>

      <footer class="mt-auto text-center text-white-50">
        <p>Footer for <a href="/" class="text-white">Shortly</a></p>
      </footer>

      <template id="linkRow">
        <tr>
          <th scope="row">3</th>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </template>
    </div>
  </body>
</html>
